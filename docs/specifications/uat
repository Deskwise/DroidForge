#!/usr/bin/env bash
#
# Unified DroidForge UAT bootstrapper.
# Prepares a clean test repo, ensures the CLI + MCP registration, then
# drops the user into `droid` ready to run /forge-start by hand.
#
# The script launches Droid exactly once per run so the user can drive the
# session manually. Assistants must never invoke Droid outside this flow—after
# the process exits, they inspect the session logs only.
#
# SETUP: Add this alias to your ~/.bashrc or ~/.zshrc:
# alias uat='~/code/DroidForge/scripts/uat'
# Then run: source ~/.bashrc (or ~/.zshrc)

set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
REPO_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)

log() {
  local level=$1; shift
  printf '[%s] %s\n' "$level" "$*" >&2
}

info()  { log INFO  "$@"; }
warn()  { log WARN  "$@"; }
error() { log ERROR "$@"; }

# Usage helper
usage() {
  cat <<EOF
Usage: uat [--linked|--latest] [--help]

Options:
  --linked   Use local build (default: builds + npm links if src newer)
  --latest   Install droidforge@latest globally (overrides --linked)
  --help     Show this help

Environment:
  DF_UAT_REPO          Target test repo (default: ~/code/droidtest)
  DF_UAT_CLEANUP       Cleanup script path
  DF_UAT_SKIP_INSTALL  Skip any install/link step
  DF_UAT_LOG_DIR       Log directory (default: ~/.factory/uat)

Examples:
  uat                 # Smart: link if src changed, else use existing
  uat --linked        # Force build + npm link
  uat --latest        # Force npm install -g droidforge@latest
EOF
}

# Parse arguments
USE_LINKED=true
FORCE_LATEST=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --linked) USE_LINKED=true; FORCE_LATEST=false; shift ;;
    --latest) USE_LINKED=false; FORCE_LATEST=true; shift ;;
    --help|-h) usage; exit 0 ;;
    *) error "Unknown option: $1"; usage; exit 1 ;;
  esac
done

# Configuration (env-overridable)
DF_UAT_REPO=${DF_UAT_REPO:-"$HOME/code/droidtest"}
DF_UAT_CLEANUP=${DF_UAT_CLEANUP:-"$HOME/.factory/cleanup-droidtest.sh"}
DF_UAT_SKIP_INSTALL=${DF_UAT_SKIP_INSTALL:-}
DF_UAT_LOG_DIR=${DF_UAT_LOG_DIR:-"$HOME/.factory/uat"}

mkdir -p "$DF_UAT_LOG_DIR"
SESSION_LOG="$DF_UAT_LOG_DIR/$(date +%Y%m%d-%H%M%S)-prep.log"
touch "$SESSION_LOG"

tee_log() {
  tee -a "$SESSION_LOG"
}

# TTY guard: refuse to launch droid without a proper terminal
if [[ ! -t 0 ]]; then
  error "stdin is not a TTY. Run 'uat' from an interactive terminal."
  info "Logs will be written to: $SESSION_LOG"
  exit 2
fi

info "DroidForge repo: $REPO_ROOT" | tee_log
info "Target test repo: $DF_UAT_REPO" | tee_log
info "Session log: $SESSION_LOG" | tee_log
info "Mode: $([ "$FORCE_LATEST" = true ] && echo "latest (global install)" || echo "$([ "$USE_LINKED" = true ] && echo "linked (local build)" || echo "existing")")" | tee_log

# Step 1 – cleanup
info "Cleaning previous test run..." | tee_log
if [[ -x "$DF_UAT_CLEANUP" ]]; then
  if ! "$DF_UAT_CLEANUP" | tee_log; then
    warn "Cleanup script reported issues (continuing)." | tee_log
  fi
else
  warn "Cleanup script not found at $DF_UAT_CLEANUP. Performing lightweight cleanup." | tee_log
  rm -rf "$DF_UAT_REPO/.droidforge" "$DF_UAT_REPO/DroidForge_user_guide_en.md" \
    "$DF_UAT_REPO/droids" "$DF_UAT_REPO/.factory" 2>/dev/null || true
fi

# Ensure test repo exists
if [[ ! -d "$DF_UAT_REPO" ]]; then
  error "Test repo $DF_UAT_REPO does not exist. Create it first." | tee_log
  exit 1
fi

# Step 2 – install/link decision
if [[ -n "$DF_UAT_SKIP_INSTALL" ]]; then
  info "Skipping install/link (DF_UAT_SKIP_INSTALL set)." | tee_log
else
  if [[ "$FORCE_LATEST" = true ]]; then
    info "Installing droidforge@latest globally..." | tee_log
    if ! npm install -g droidforge@latest | tee_log; then
      error "npm install failed." | tee_log
      exit 3
    fi
  elif [[ "$USE_LINKED" = true ]]; then
    # Determine if we need to rebuild/link
    NEED_REBUILD=false
    if [[ -f "$REPO_ROOT/dist/mcp/server.js" ]]; then
      # Simple heuristic: if any src file is newer than dist, rebuild
      if find "$REPO_ROOT/src" -type f -newer "$REPO_ROOT/dist/mcp/server.js" -quit 2>/dev/null; then
        NEED_REBUILD=true
      fi
    else
      NEED_REBUILD=true
    fi
    if [[ "$NEED_REBUILD" = true ]]; then
      info "Local src newer than dist or no dist; building + linking..." | tee_log
      if ! "$REPO_ROOT/scripts/dev-link.sh" | tee_log; then
        error "dev-link failed." | tee_log
        exit 4
      fi
    else
      info "Local dist is up to date; skipping rebuild." | tee_log
    fi
    # Verify link points to our repo
    LINKED_TARGET=$(npm list -g --depth=0 --json 2>/dev/null | jq -r '.dependencies.droidforge' 2>/dev/null || echo "")
    if [[ "$LINKED_TARGET" != "$REPO_ROOT" ]]; then
      warn "Linked droidforge does not point to repo root ($LINKED_TARGET). Re-linking..." | tee_log
      if ! (cd "$REPO_ROOT" && npm link) | tee_log; then
        error "npm link failed." | tee_log
        exit 5
      fi
    fi
  else
    # Default: install latest if nothing exists
    if ! command -v droid >/dev/null 2>&1; then
      info "No droid command found; installing droidforge@latest globally..." | tee_log
      if ! npm install -g droidforge@latest | tee_log; then
        error "npm install failed." | tee_log
        exit 6
      fi
    else
      info "Using existing droid installation." | tee_log
    fi
  fi
fi

# Step 3 – MCP registration
info "Refreshing MCP registration..." | tee_log
if ! droid mcp remove droidforge >/dev/null 2>&1; then
  warn "No existing MCP entry to remove." | tee_log
fi
if ! droid mcp add droidforge droidforge-mcp-server --type stdio | tee_log; then
  error "Failed to register droidforge MCP server." | tee_log
  exit 7
fi
sleep 2

# Step 4 – launch enhanced onboarding flow
info "Launching enhanced droid in $DF_UAT_REPO." | tee_log
cd "$DF_UAT_REPO"
echo "======================================================================"
echo "DroidForge UAT shell ready with enhanced vision comprehension."
echo "Run /forge-start to test improved onboarding flow."
echo "UAT prep log: $SESSION_LOG"
echo "Droid session logs: ~/.factory/sessions/"
echo "Main droid log: ~/.factory/logs/droid-log-single.log"
echo "======================================================================"
echo "Quick log commands:"
echo "  tail -f ~/.factory/logs/droid-log-single.log"
echo "  ls -la ~/.factory/sessions/ | head -5"
echo "======================================================================"
echo "To resume this session later, run:"
echo "  export DF_UAT_SKIP_INSTALL=1 && uat"
echo "======================================================================"
exec droid
